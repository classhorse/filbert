--╔╗ ╦ ╗╔ ╔╗ ╦
--║║ ║ ║║ ║║ ║
--╠╝ ╩ ╚╝ ╚╝ ║

select 
	*

from

	(
		select
			
			[sum] = sum(dc.intsum),
			[bank] = b.name,
			[weekday] = DATENAME(weekday, dc.calc_date)
			
		from 
			bank as b
			inner join portfolio as p on b.id = p.parent_id
			inner join debt as d on p.id = d.r_portfolio_id
			inner join person as per on d.parent_id = per.id
			left join
					(
						select
							parent_id,
							sum(int_sum) intsum,
							calc_date
						from
							debt_calc
						group by
							parent_id,
							calc_date
							
					)dc		on dc.parent_id = d.id

		group by
			b.name,
			DATENAME(weekday, dc.calc_date)



	)dc

pivot
	(

		sum([sum])
		
		FOR [weekday] in

						(
							понедельник, вторник, среда, четверг, пятница, суббота, воскресенье
						)

	)p


---------------------------------------------------------------------------

--trassirovka

--declare @d1 date
--declare @d2 date

--set @d1 = @bd
--set @d2 = @ed
select * from(

select

	[hour] = datepart(hour,cl.dt),
	[portf] = p.name,
	--[try] = count(cl.id)
	[contact] = count(case 
			when cl.result in 
							(
								120239,120189,120190,120191,120202,120200,120198,120196,120194,120201,120199,
								120197,120195,120193,120237,120228,120218,120240,120236,120227,120217,120213,
								120210,120207,120204,120234,120225,120216,120212,120209,120206,120203,120232,
								120224,120215,120241,120231,120222,120214,120211,120208,120205,120192,120188,
								120187,120186,120185,120184,120183,120182,320271,320272,320273,320274,320321,
								320319,320317,320315,320322,320320,320318,320316,320314,320313,320312,320311,
								320310,320309,320308,320307,320306,320305,320304,320303,320302,320301,320300,
								320299,320298,320297,320296,320295,320294,320293,320292,320291,320290,320289,
								320288,320287,320286,320285,320284,320283,320282,320281,320280,320279,838,839,
								840,841,842,816,818,820,822,824,827,830,817,819,821,823,828,825,831,829,826,832,
								861,862,863,864,865,866,867,868,870,869,871,872,873,874,875,876,878,877,879,881,
								880,882,320163,714,1,15,3,4,715,11,16,13,327,5,321,717,201,706,203,204,718,207,
								707,209,713,712,220,205,111,115,113,109,117,101,118,108,110,843,844,845,846,847,
								849,851,853,860,848,850,852,854,859,856,855,858,320347,320345,320343,320341,
								320349,320346,320344,320342,320340
							)
		then cl.id
	end) 

	--[perspect] = count(case 
	--	when cl.result in 
	--					(
	--						320344,320346,320345,320347,850,848,849,847,844,843,118,101,115,111,
	--						707,207,718,706,201,717,16,11,715,15,1,714,875,874,873,868,867,866,
	--						863,862,861,821,819,817,820,818,816,840,839,838,320283,320284,320285,
	--						320290,320291,320292,320293,320294,320295,320300,320301,320302,320307,
	--						320308,320309,320310,320311,320312,320316,320318,320320,320317,320319,
	--						320321,320273,320272,320271,120186,120187,120188,120214,120222,120231,
	--						120215,120224,120232,120216,120225,120234,120217,120227,120236,120218,
	--						120228,120237,120197,120199,120201,120198,120200,120202,120190,120189,120239,
	--						1,2,3,4,5,11,12,13,14,15,16,310,714,715,716,720,723,58,803,805,806,807,808, 
	--						809,816,817,818,819,820,821,822,823,824,825,826,839,840,841,842,20044,
	--						120044,120045,120048,120153,120154,120156
	--					)
	--	then cl.id
	--end) 

from
	contact_log cl
	left join debt d on cl.r_debt_id = d.id
	left join portfolio p on p.id = d.r_portfolio_id
	--left join bank b on p.parent_id = b.id

					

where
	cl.typ in (1,3)
	--and cl.dt between @d1 and @d2

group by
	datepart(hour, cl.dt),
	p.name

)t

pivot

		(
			sum([contact])
			for [hour] in 
						(
							[0], [1], [2], [3], [4], [5], [6], [7], [8], [9], [10],
							[11], [12], [13], [14], [15], [16], [17], [18], [19],
							[20], [21], [22], [23]
						)

		)p